function handleError(e){throw new Error(e.ErrorMessage)}function errorCallback(e){return function(n){console.log(n),e.status(500),e.send("ERROR!")}}const express=require("express"),bodyParser=require("body-parser"),pg=require("pg"),app=express();var mailjet=require("node-mailjet").connect("7672f7d7861def0d58556c8fde5fd009","e46c285ea610edd14646958ed4ce3223");app.use(express.static("public")),app.use(bodyParser.json());var pool=require("./pg-connection-pool");app.post("/events",function(e,n){var t=e.body,o=[t.eventName,t.date,t.description,t.lat,t.lng,t.linkto];pool.query("INSERT INTO events(eventname, eventdate, description, lat, lng, linkto) VALUES ($1::text, $2::date, $3::text, $4::decimal, $5::decimal, $6::text)",o).then(function(){n.status(201),n.send("INSERTED")}).catch(errorCallback(n))}),app.post("/eventmanage",function(e,n){var t=e.body,o=e.body.text,r=o.replace(/"/g,""),a=e.body.column,s=[o,t.id],c=[r,t.id];console.log(a),"description"==a?pool.query("UPDATE events SET description = $1::text WHERE id =$2::int",s).then(function(){n.status(201),n.send("INSERTED")}).catch(errorCallback(n)):"event name"==a?pool.query("UPDATE events SET eventname = $1::text WHERE id =$2::int",s).then(function(){n.status(201),n.send("INSERTED")}).catch(errorCallback(n)):"link"==a?pool.query("UPDATE events SET linkto = $1::text WHERE id =$2::int",s).then(function(){n.status(201),n.send("INSERTED")}).catch(errorCallback(n)):"date"==a&&pool.query("UPDATE events SET eventdate = $1::date WHERE id =$2::int",c).then(function(){n.status(201),n.send("INSERTED")}).catch(errorCallback(n))}),app.post("/contact",function(e,n){function t(){email={},email.FromName=o.name,email.FromEmail="soprano.nicole.joseph@gmail.com",email.Subject="Message From "+o.email,email.Recipients=[{Email:"soprano.nicole.joseph@gmail.com"}],email["Text-Part"]=o.message,mailjet.post("send").request(email).then(function(){n.status(201),n.send("Sent")}).catch(errorCallback(n))}var o=e.body;t()}),app.get("/events",function(e,n){pool.query("SELECT * FROM events ORDER BY eventdate ASC").then(function(e){n.send(e.rows)}).catch(function(e){console.log(e)})}),app.get("/recent",function(e,n){pool.query("SELECT * FROM events where eventdate + INTERVAL '24 HOUR' > now() ORDER BY eventdate ASC LIMIT 3").then(function(e){e.rows.length<3?pool.query("SELECT * FROM events ORDER BY eventdate DESC LIMIT 3").then(function(e){n.send(e.rows)}):n.send(e.rows)}).catch(function(e){console.log(e)})}),app.get("/viewevent",function(e,n){var t=e.query.id;t=Number(t);var o=[t];pool.query("select * from events where id = $1::int",o).then(function(e){n.send(e.rows)}).catch(function(e){console.log(e)})}),app.get("/eventlogin",function(e,n){var t=e.query.username,o=[t];console.log(e.body),pool.query("SELECT * FROM login WHERE username = $1::text",o).then(function(e){n.send(e.rows)}).catch(function(e){console.log(e)})}),app.delete("/deletepost",function(e,n){var t=Number(e.query.postid),o=[t];pool.query("DELETE FROM events WHERE id = $1::int",o).then(function(){n.send("DELETED")}).catch(n)});var port=process.env.PORT||5e3;app.listen(port,function(){console.log("JSON Server is running on "+port)});